name: Build and test
# This workflow is triggered on pushes to the repository.
on: [push]

jobs:
  build_client:
    name: Install, build and test
    runs-on: ubuntu-18.04
    steps:
      - name: Check Out
        uses: actions/checkout@v1
      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: 10.x
      - name: Install Firebase 
        run: yarn global add firebase-tools
      - name: Install Client Dependencies
        run: yarn --cwd "client" install --non-interactive --pure-lockfile
      - name: Install Server Dependencies
        run: yarn --cwd "server" install --non-interactive --pure-lockfile
      - name: Install Function Dependencies
        run: yarn --cwd "functions" install --non-interactive --pure-lockfile
      - name: Lint Client
        run: yarn --cwd "client" run lint
      - name: Build Client
        run: CI=false yarn --cwd "client" run build
      - name: Build Server
        run: CI=false yarn --cwd "server" run build
      - name: Create Server Container
        run: yarn --cwd "server" run buildDocker
      - name: Deploy Client
        run: firebase deploy -m "Github Action, Commit ${{ github.head_ref }}" --non-interactive --token ${{ secrets.FIREBASE_TOKEN }}
